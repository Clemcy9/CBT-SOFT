{% extends 'base.html' %}
{% load randomize %}
{% block content %}
<div class="container">
    <h3 style="text-align: end;">Time Left: <strong id="time-left-min"></strong>:<strong id="time-left-secs"></strong>secs</h3>
    
    
    <form action="{% url 'cbt_app:quiz_progress' %}" method="post">
        {% csrf_token %}
        <input type="hidden" value="{{sitting.id}}" name="sitting">
        
        {% for question in questions %}
            <legend>
                <h3>{{forloop.counter}}. {{question.content}}</h3>
            </legend>
            {% if error_message %}
            <p><strong>{{ error_message }}</strong></p>
            {% endif %}
            <input type="hidden" value="{{question.id}}" name="question{{question.id}}">
            <fieldset>
                {% for choice in question.choice_set.all|randomize %}
                <input  type="radio" name="choice{{question.id}}" value="{{choice.id}}" > 
                <label for="choice{{question.id}}">{{choice.content}} </label> <br>
                
                {% endfor %}
            </fieldset>
        {% endfor %}
        <input type="submit" value="Next" style="margin-top: 2em;" id="submit" onclick="updateDbTime()">
    </form>
</div>
<script>

// fetch post and get request
    async function makeRequest(url, method, data){
        let headers ={
            'X-Requested-With':'XMLHttpRequest',
            'Content-Type':'application/text'
        }

        if(method == 'post'){
            const csrf = document.querySelector('[name = csrfmiddlewaretoken]').value
            headers['X-CSRFToken'] = csrf
        }

        let response = await fetch(url,{
            method:method,
            headers:headers,
            body:JSON.stringify(data)
        })

        return await response.status
    } 

    
    // timer countdown
        const timeLeftmin = document.querySelector('#time-left-min');
        const timeLeftsec = document.querySelector('#time-left-secs');
        const submit = document.querySelector('#submit');
        let timeLeft = {{time_left}} *60 ; //convert min to secs
        let min = 0;
        let secs = 0;

        function countDown() {
            setInterval(function () {
                if (timeLeft <= 0) {
                    clearInterval(timeLeft = 0)
                }
                if (timeLeft == 2) {
                    // submit.attr("disabled", true);
                    submit.click()
                }
                timeLeft--;
                // let post =
                min = Math.floor(timeLeft/60) // minute only half of the countdown
                secs= Math.round(((timeLeft/60)-min)*60) // seconds only half of the countdown
                timeLeftmin.innerHTML = min
                timeLeftsec.innerHTML = secs
            }, 1000)

            
        }
        function updateDbTime(){
            makeRequest(
                "{% url 'cbt_app:time_update' sitting.quiz.id %}",
                'post',
                {'time':timeLeft, 
                'sitting': {{sitting.id}}, }
            )
            alert(['time left is =',timeleft])
        }
    document.addEventListener(onload,countDown())
    
</script>
{% endblock %}